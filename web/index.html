<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LiveDrop Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/admin.css" />
  </head>
  <body>
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-brand">LIVEDROP_ADMIN</h1>
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a class="nav-link active" onclick="switchView(event, 'view-dashboard')">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="switchView(event, 'view-auth')">Authentication</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="switchView(event, 'view-stream')">Stream Control</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="switchView(event, 'view-rules')">Rules Engine</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="switchView(event, 'view-monitor')">Live Monitor</a>
        </li>
      </ul>
      <div class="sidebar-footer">
        <p id="status">Ready.</p>
        <p style="margin-top: 0.5rem; opacity: 0.5;">v1.0.0</p>
      </div>
    </nav>

    <main class="main-content">
      <header class="topbar">
        <div class="topbar-title">
          <h2 class="topbar-heading">Control Room</h2>
          <p class="topbar-sub">Manage stream invites, events, and giveaways from one panel.</p>
        </div>
        <div class="topbar-actions">
          <span id="chipAuth" class="chip">Guest</span>
          <span id="chipSession" class="chip">No Active Session</span>
          <button type="button" class="ghost" id="goToStream">Stream</button>
          <button type="button" class="ghost" id="goToMonitor">Monitor</button>
          <button type="button" class="ghost" id="logoutBtn" style="display: none;">Logout</button>
        </div>
      </header>

      <section id="view-dashboard" class="view-section active">
        <h2>Streamer Control Room</h2>
        <div class="card">
          <p style="font-size: 1.1rem; color: var(--text-main); margin-bottom: 2rem;">
            Launch stream giveaways, share invite links, map event triggers to rewards, and monitor rounds in real time.
          </p>
          <div class="kpi-grid">
            <div class="kpi">
              <p class="kpi-label">Role</p>
              <p class="kpi-value" id="kpiRole">guest</p>
            </div>
            <div class="kpi">
              <p class="kpi-label">Session</p>
              <p class="kpi-value" id="kpiSession">none</p>
            </div>
            <div class="kpi">
              <p class="kpi-label">Preset Events</p>
              <p class="kpi-value" id="kpiPresets">0</p>
            </div>
            <div class="kpi">
              <p class="kpi-label">Latest Events</p>
              <p class="kpi-value" id="kpiEvents">0</p>
            </div>
          </div>
          <h3>Flow</h3>
          <ol class="flow-list">
            <li><strong>1.</strong> Login as streamer/admin (Auth).</li>
            <li><strong>2.</strong> Start stream session and share invite (Stream Control).</li>
            <li><strong>3.</strong> Add reward rules from presets (Rules Engine).</li>
            <li><strong>4.</strong> Monitor live events and winners (Live Monitor).</li>
          </ol>
        </div>
      </section>

      <section id="view-auth" class="view-section">
        <h2>Authentication</h2>
        <div class="grid two">
          <div class="card">
            <h3>Create Account</h3>
            <form id="registerForm">
              <input name="username" placeholder="Username" required />
              <input name="email" type="email" placeholder="Email" required />
              <input name="password" type="password" placeholder="Password (8+ chars)" required />
              <button type="submit">Register</button>
            </form>
          </div>
          <div class="card">
            <h3>Login</h3>
            <form id="loginForm">
              <input name="identity" placeholder="Email or username" required />
              <input name="password" type="password" placeholder="Password" required />
              <button type="submit">Login</button>
            </form>
          </div>
        </div>
        <div class="card" style="margin-top: var(--spacing);">
          <div class="role-bar" style="border: none; margin: 0; padding: 0;">
            <p id="roleLabel" style="margin: 0; font-weight: bold; color: var(--text-bright);">Role: guest</p>
            <button type="button" class="ghost" id="enableStreamer">Enable Streamer Mode</button>
            <button type="button" class="ghost" id="refreshMe">Refresh Profile</button>
          </div>
        </div>
      </section>

      <section id="view-stream" class="view-section">
        <h2>Stream Control</h2>
        <div class="grid two">
          <div class="card">
            <h3>Start Session</h3>
            <form id="startStreamForm">
              <input name="title" placeholder="Stream title" value="CS2 Giveaway Live" required />
              <input name="telegram_chat_id" placeholder="Telegram chat id (optional)" />
              <label class="checkbox"><input type="checkbox" name="send_to_chat" checked /> Send invite via bot chat</label>
              <div style="display: flex; gap: 1rem;">
                <button type="submit">Start Stream</button>
                <button type="button" class="ghost" id="loadActiveStream">Load Active</button>
              </div>
            </form>
          </div>
          <div class="card">
            <h3>Invite Pack</h3>
            <p class="hint">After stream starts, copy one of these links and share it in chat.</p>
            <div class="invite-actions">
              <button type="button" class="ghost" id="copyInviteLink">Copy Link</button>
              <button type="button" class="ghost" id="copySteamLink">Steam Link</button>
              <button type="button" class="ghost" id="copyDeepLink">Deep Link</button>
              <button type="button" class="ghost" id="openSimulator">Simulator</button>
            </div>
            <pre id="streamOutput" style="max-height: 200px;">Waiting for stream...</pre>
            <div id="qrWrap" class="qr-wrap" style="margin-top: 1rem;"></div>
          </div>
        </div>
        <div class="card" style="margin-top: var(--spacing);">
          <h3>Crowdfunding Campaign</h3>
          <form id="campaignForm" class="grid three" style="align-items: end;">
            <input name="title" placeholder="Campaign title" value="Community Drop Pot" required />
            <select name="reward_item_type">
              <option value="case">Reward: Case</option>
              <option value="skin">Reward: Skin</option>
            </select>
            <input name="reward_item_name" placeholder="Reward item name" value="Revolution Case" />
            <input name="description" placeholder="Description" value="Fund together and win the drop." />
            <input name="target_amount_dollars" type="number" min="1" step="1" value="50" required />
            <button type="submit">Create Campaign</button>
          </form>
          <div class="campaign-progress" style="margin-top: 1rem;">
            <div class="campaign-progress-bar" id="campaignProgressBar"></div>
          </div>
          <pre id="campaignOutput" style="margin-top: 1rem;">No campaign loaded.</pre>
          <div style="display:flex; gap:0.7rem; margin-top:0.7rem;">
            <button type="button" class="ghost" id="loadCampaignByInvite">Load By Invite</button>
          </div>
        </div>
      </section>

      <section id="view-rules" class="view-section">
        <h2>Rules Engine</h2>
        <div class="grid two">
          <div class="card">
            <h3>Preset Events</h3>
            <div id="presetList" class="preset-list"></div>
          </div>
          <div class="card">
            <h3>Add / Update Rule</h3>
            <form id="ruleForm">
              <input name="session_id" placeholder="Session ID" required />
              <input name="rule_id" placeholder="Rule ID (for update only)" />
              <input name="trigger_type" placeholder="ace / headshot / bomb_plant" required />
              <div class="grid two" style="gap: 1rem; margin-bottom: 0;">
                <select name="prize_type">
                  <option value="case">Case</option>
                  <option value="skin">Skin</option>
                </select>
                <input name="prize_cents" type="number" value="200" min="0" required />
              </div>
              <div id="caseRewardWrap">
                <select name="case_prize_name">
                  <option value="Revolution Case">Revolution Case</option>
                  <option value="Kilowatt Case">Kilowatt Case</option>
                  <option value="Knife Fever Case">Knife Fever Case (Premium / Knife chance)</option>
                </select>
                <div class="skin-preview" id="casePreview">
                  <img id="casePreviewImg" alt="Case preview" />
                  <p id="casePreviewName">Pick a case reward</p>
                </div>
              </div>
              <div id="skinRewardWrap" style="display:none;">
                <select name="skin_prize_name"></select>
                <div class="skin-preview" id="skinPreview">
                  <img id="skinPreviewImg" alt="Skin preview" />
                  <p id="skinPreviewName">Pick a skin reward</p>
                </div>
              </div>
              <input type="hidden" name="prize_name" value="Revolution Case" />
              <label class="checkbox"><input type="checkbox" name="enabled" checked /> Rule enabled</label>
              <div class="grid two" style="gap: 1rem;">
                <button type="submit">Create Rule</button>
                <button type="button" id="updateRule" class="ghost">Update</button>
              </div>
              <button type="button" id="loadRules" class="ghost" style="width: 100%; margin-top: 1rem;">Load Rules</button>
            </form>
          </div>
        </div>
        <div class="card" style="margin-top: var(--spacing);">
          <h3>Active Rules JSON</h3>
          <pre id="rulesOutput">No rules loaded.</pre>
        </div>
      </section>

      <section id="view-monitor" class="view-section">
        <h2>Live Monitor</h2>
        <div class="card" style="margin-bottom: var(--spacing);">
          <h3>Test Event Generator</h3>
          <p class="hint">Use this to validate GSI-to-giveaway flow without running CS2.</p>
          <form id="fakeEventForm" class="grid three">
            <select name="event_type">
              <option value="ace">ace</option>
              <option value="headshot">headshot</option>
              <option value="bomb_plant">bomb_plant</option>
              <option value="round_win">round_win</option>
              <option value="kill">kill</option>
              <option value="death">death</option>
            </select>
            <input name="count" type="number" min="1" max="20" value="1" placeholder="Count" />
            <button type="submit">Simulate Event</button>
          </form>
        </div>
        <div class="grid two">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3>Giveaway Rounds</h3>
              <button id="refreshRounds" class="ghost" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">Refresh</button>
            </div>
            <pre id="roundsOutput" style="height: 400px;">Waiting for rounds...</pre>
          </div>
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3>Events Feed</h3>
              <button id="refreshEvents" class="ghost" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">Refresh</button>
            </div>
            <pre id="eventsOutput" style="height: 400px;">Waiting for events...</pre>
          </div>
        </div>
      </section>

    </main>

    <script src="/app.js" defer></script>
    <script>
      function switchViewById(viewId) {
        document.querySelectorAll('.view-section').forEach((el) => {
          el.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');
        
        document.querySelectorAll('.nav-link').forEach((el) => {
          el.classList.remove('active');
        });
        const activeLink = document.querySelector(`.nav-link[onclick*="${viewId}"]`);
        if (activeLink) activeLink.classList.add('active');
      }

      function switchView(event, viewId) {
        event.preventDefault();
        switchViewById(viewId);
        if (event.target) event.target.classList.add('active');
      }
    </script>
  </body>
</html>
